<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wing Lab</title>
  <style>
    html,body{height:100%;margin:0;background:radial-gradient(1200px 600px at 50% -10%, #2a2240 0%, #130f16 55%, #0a0710 100%); color:#eae6ff;}
    .ui{position:fixed;inset:16px;display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .ui .card{backdrop-filter: blur(8px); background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12); padding:10px 12px; border-radius:14px; box-shadow:0 6px 24px rgba(0,0,0,.25)}
    label{font-size:.9rem;opacity:.9;margin-right:8px}
    select,input[type="range"]{background:#1c1420;color:#eae6ff;border:1px solid #4b3a56;border-radius:10px;padding:6px}
    button{background:#6a4b97;color:white;border:0;border-radius:12px;padding:8px 12px;cursor:pointer}
    button:hover{filter:brightness(1.1)}
    #scene{position:fixed;inset:0;display:block;width:100%;height:100%}
  </style>
</head>
<body>
  <canvas id="scene"></canvas>
  <div class="ui">
    <div class="card">
      <label>Avatar</label>
      <select id="avatar">
        <option value="../asset/models/abbey.vrm">Abbey</option>
        <option value="../asset/models/stella.vrm">Stella</option>
        <option value="../asset/models/tracy.vrm">Tracy</option>
      </select>
      <button id="loadAvatar">Load</button>
    </div>

    <div class="card">
      <label>Wings (GLB)</label>
      <select id="wingsGlb"></select>
      <button id="addGlb">Attach</button>
    </div>

    <div class="card">
      <label>Wings (PNG)</label>
      <select id="wingsPng"></select>
      <button id="addPng">Manufacture</button>
    </div>

    <div class="card">
      <label>Flap</label>
      <input id="flap" type="checkbox"/>
      <label style="margin-left:10px">Scale</label>
      <input id="scale" type="range" min="50" max="200" value="100"/>
      <label style="margin-left:10px">Spread</label>
      <input id="spread" type="range" min="20" max="120" value="50"/>
      <button id="detach" style="margin-left:10px">Detach</button>
      <a href="../index.html" style="margin-left:10px;color:#fff;text-decoration:none">Home</a>
    </div>
  </div>

  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.152.2/build/three.module.js';
    import { createBasicScene, loadVRM, attachWingsFromGLB, attachWingsFromPNG, makeWingFlap, detachWings } from '../asset/js/wings-bundle.js';

    const canvas = document.getElementById('scene');
    const { renderer, scene, camera, controls, clock } = createBasicScene({ canvas });

    let vrm = null;

    async function bootAvatar(url){
      // clear scene except lights/grid/camera
      const keep = new Set([camera]);
      scene.traverse(o=>{ if(o.isLight || o.type==='GridHelper' || o===camera) keep.add(o); });
      [...scene.children].forEach(c=>{ if(!keep.has(c)) scene.remove(c); });
      vrm = await loadVRM(url, scene);
    }

    // Populate dropdowns from manifest (if any)
    async function loadManifest(){
      const glbSel = document.getElementById('wingsGlb');
      const pngSel = document.getElementById('wingsPng');
      const glbDefaults = ['angel_wings.glb','butterfly_wings.glb'];
      const pngDefaults = ['butterfly_sheet.png','angel_sheet.png'];
      let glbList = glbDefaults, pngList = pngDefaults;
      try {
        const res = await fetch('../asset/models/wings/manifest.json');
        if(res.ok){
          const m = await res.json();
          glbList = m.glb || glbList;
          pngList = m.png || pngList;
        }
      } catch(e) {}
      glbSel.innerHTML = glbList.map(n=>`<option value="../asset/models/wings/${n}">${n}</option>`).join('');
      pngSel.innerHTML = pngList.map(n=>`<option value="../asset/textures/wings/${n}">${n}</option>`).join('');
    }

    await loadManifest();

    document.getElementById('loadAvatar').addEventListener('click', async ()=>{
      const url = document.getElementById('avatar').value;
      await bootAvatar(url);
    });

    document.getElementById('addGlb').addEventListener('click', async ()=>{
      if(!vrm) return alert('Load an avatar first');
      const url = document.getElementById('wingsGlb').value;
      const scale = Number(document.getElementById('scale').value)/100;
      await attachWingsFromGLB(vrm, url, { scale });
    });

    document.getElementById('addPng').addEventListener('click', async ()=>{
      if(!vrm) return alert('Load an avatar first');
      const url = document.getElementById('wingsPng').value;
      const scale = Number(document.getElementById('scale').value)/100;
      const spread = Number(document.getElementById('spread').value)/100;
      await attachWingsFromPNG(vrm, url, { width:0.7*scale, height:0.7*scale, spread:0.8*spread });
    });

    document.getElementById('detach').addEventListener('click', ()=>{ if(vrm) detachWings(vrm); });

    const flap = document.getElementById('flap');
    const getWings = ()=> vrm?.userData?.wings || null;
    const flapFn = makeWingFlap(()=>getWings());

    function tick(){
      const dt = clock.getDelta();
      if(flap.checked) flapFn(dt);
      controls.update();
      renderer.render(scene, camera);
      requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);

    // Auto-load first avatar; replace filenames with yours when ready
    await bootAvatar(document.getElementById('avatar').value);
  </script>
</body>
</html>
